---
title: OWA Lineage CTmax Project
date: "`r Sys.Date()`"
output: 
  html_document:
          code_folding: hide
          code_download: true
          toc: true
          toc_float: true 
  github_document:
          html_preview: false
          toc: true
          toc_depth: 3
---

```{r setup, include=T, message = F, warning = F, echo = F}
knitr::opts_chunk$set(
  echo = knitr::is_html_output(),
  fig.align = "center",
  fig.path = "../Figures/markdown/",
  message = FALSE,
  warning = FALSE,
  collapse = T,
  dev = c("png", "pdf")
)

theme_matt = function(base_size = 18,
                      dark_text = "grey20"){
  mid_text <-  monochromeR::generate_palette(dark_text, "go_lighter", n_colours = 5)[2]
  light_text <-  monochromeR::generate_palette(dark_text, "go_lighter", n_colours = 5)[3]
  
  ggpubr::theme_pubr(base_family="sans") %+replace% 
    theme(
      panel.background  = element_blank(),
      plot.background = element_rect(fill="transparent", colour=NA), 
      legend.background = element_rect(fill="transparent", colour=NA),
      legend.key = element_rect(fill="transparent", colour=NA),
      text = element_text(colour = mid_text, lineheight = 1.1),
      title = element_text(size = base_size * 1.5,
                           colour = dark_text),
      axis.text = element_text(size = base_size,
                               colour = mid_text),
      axis.title = element_text(size = base_size * 1.2,
                                margin = margin(0, 8, 0, 0)),
      legend.text = element_text(size=base_size * 0.9),
      legend.title = element_text(size = base_size * 0.9, 
                                  face = "bold"),
      plot.margin = margin(0.25, 0.25, 0.25, 0.25,"cm")
    )
}

lineage_cols = c("AA" = "#0C7BDF",
                 "AH" = "#009D77", 
                 "HA" = "#FFA602", 
                 "HH" = "#D55D07")

full_data = full_data %>%  
  mutate(temp = str_split_i(lineage, pattern = "", i = 1),
         co2 = str_split_i(lineage, pattern = "", i = 2),
         temp = if_else(temp == "H", "High", "Ambient"),
         co2 = if_else(co2 == "H", "High", "Ambient"))
```

# Sample sizes
This summary reports the results of `r max(full_data$run)` replicate CTmax trials. The four lineages were sampled randomly for each replicate experiment, with one replicate culture per lineage per run. 
```{r sample-sizes}
full_data %>% 
  count(lineage) %>% 
  knitr::kable()
```

# Trait measurements    
## Body length
All copepods were measured after the CTmax assay. These length measurements are shown below. 
```{r lineage-lengths, fig.height=5, fig.width=5}
ggplot(full_data, aes(x = lineage, y = length, fill = lineage)) + 
  geom_boxplot(outlier.colour = NA) + 
  geom_point(size = 2, position = position_jitter(width = 0.1, height = 0)) + 
  scale_fill_manual(values = lineage_cols) + 
  labs(x = "Lineage", 
       y = "Length (mm)") + 
  theme_matt(base_size = 16) + 
  theme(legend.position = "none")
```

Just to note, a couple individuals appear to be on the small side, which risks the introduction of both C6 and juvenile individuals. 
```{r, include = F}
ggplot(full_data, aes(x = length)) + 
  geom_histogram(binwidth = 0.01) + 
  theme_matt() + 
  theme_matt(base_size = 16) + 
  theme(legend.position = "none")
```

## CTmax    
The focal trait was the upper thermal limit, measured here as CTmax - the critical thermal maximum. During these assays, temperature increases at a rate of 0.1-0.3 degrees C per minute. As shown below, ramping rate decreases linearly over time due to imperfect insulation of the water bath reservoir. Rates are always between 0.3 and 0.1 degrees C per minute, however, which is the range of ramping rates typically used in copepod CTmax assays. 

```{r ramp-rates, fig.height=5, fig.width=5}
ramp_record2 = ramp_record %>% 
  group_by(run, minute_interval) %>% 
  summarise(mean_ramp = mean(ramp_per_minute)) %>% 
  drop_na(minute_interval, mean_ramp) 

ggplot(ramp_record2, aes(x = minute_interval, y = mean_ramp)) + 
  geom_hline(yintercept = 0.3) + 
  geom_hline(yintercept = 0.1) + 
  #geom_point() + 
  geom_hex(bins = 30) + 
  #scale_fill_continuous(lim=c(2,25), na.value=NA) + 
  #ylim(0,0.32) + 
  labs(y = "Ramp Rate (deg. C / min.)",
       x = "Time into run (minute)") + 
  theme_matt(base_size = 16) + 
  theme(legend.position = c(0.3, 0.1), 
        legend.direction = "horizontal")
```

Individuals are monitored until they reach their thermal limit, indicated by a lack of responsiveness to stimuli. This is traditionally considered an "ecological death" endpoint. Measured CTmax values are shown below. A few anomalously low CTmax values (<33 degrees C) were excluded. There were `r dim(full_data %>% filter(ctmax < 33))[1]`` total measurements excluded, summarize below.

```{r}
kable(full_data %>% 
        filter(ctmax < 33) %>% 
        count(lineage), 
      caption = "Number of individual measurements excluded from each of the lineages")
```


```{r lineage-ctmax, fig.height=5, fig.width=5}
full_data %>% 
  #filter(length > 0.72) %>% 
  filter(ctmax > 33) %>% 
  ggplot(aes(x = lineage, y = ctmax, fill = lineage)) + 
  geom_boxplot(outlier.colour = NA) + 
  geom_point(position = position_jitter(width = 0.1, height = 0)) + 
  scale_fill_manual(values = lineage_cols) + 
  labs(x = "Lineage", 
       y = "CTmax (degrees C)") + 
  theme_matt(base_size = 16) + 
  theme(legend.position = "none")
```

To test for differences between lineages, we fit a linear mixed effects model to the data (CTmax ~ lineage + length, with a nested random effect of replicate within lineage). There's currently no significant difference between lineages, but there is a significant effect of length. We still need to do a posthoc test to examine pairwise differences between lineages. 

```{r}
ctmax.model = nlme::lme(ctmax ~ lineage + length, 
                        random = ~1|lineage/replicate, 
                        data = filter(full_data, ctmax > 33))

kable(car::Anova(ctmax.model))

#model_resid = resid(ctmax.model, type = 'pearson')
#qqnorm(model_resid); qqline(model_resid, col = 2)
```

We also examined whether the individual environmental factors (temperature or CO2 levels) affected CTmax. Culturing temperature appears to have a significant effect on CTmax, while CO2 level does not. Further, there is no interaction between the two factors, suggesting that CO2 level does not alter the effect that temperature has on CTmax. 
```{r}
env.model = nlme::lme(ctmax ~ temp * co2, 
                        random = ~1|lineage/replicate, 
                        data = filter(full_data, ctmax > 33))

kable(car::Anova(env.model, test = "F", type = "III"))

table(full_data$lineage, full_data$replicate)

#env.model_resid = resid(env.model, type = 'pearson')
#qqnorm(env.model_resid); qqline(env.model_resid, col = 2)
```

```{r, include = F}
# While this is surprising at first glance, it appears to be driven by large variation within lineages. Shown below are the CTmax values for each of the four lineages, separated out into the different replicate cultures copepods were selected from. In the AH and HA lineages in particular there seems to be some strong variation between replicates. 

full_data %>% 
  filter(ctmax > 33) %>% 
  ggplot(aes(x = replicate, y = ctmax, fill = lineage, group = replicate)) + 
  facet_wrap(lineage~.) + 
  geom_boxplot(outlier.colour = NA) + 
  geom_point(position = position_jitter(width = 0.1, height = 0)) + 
  scale_fill_manual(values = lineage_cols) + 
  labs(x = "Lineage", 
       y = "CTmax (degrees C)") + 
  theme_matt(base_size = 16) + 
  theme(legend.position = "none")
```

```{r include = F}
# Examines the relationships between CTmax and length within each lineage, with points colored by replicate. Attempting to look at why the AH and HA lineages are so much more variable across replicates than the AA or HH lineages.
full_data %>% 
  filter(ctmax > 33) %>% 
  ggplot(aes(x = length, y = ctmax)) + 
  facet_wrap(lineage~.) + 
  geom_point(aes(colour = factor(replicate)), 
             size = 2) + 
  geom_smooth(method = lm) + 
  labs(x = "Length (mm)", 
       y = "CTmax (degrees C)") + 
  theme_bw() + 
  theme(panel.grid = element_blank())
```


# Trait correlations    
Across lineages, thermal limits tend to decrease with increasing body size. The relationship between measured lengths and CTmax from these assays is shown below. Note that the smaller individuals (lengths <0.75mm) tend to be from the HA and HH lineages. It might be worth going back to the images to double check the stage of these individuals to ensure only adult females were included.      

```{r length-ctmax, fig.height=5, fig.width=5}
full_data %>% 
  filter(ctmax > 33) %>% 
  ggplot(aes(x = length, y = ctmax)) + 
  geom_smooth(method = "lm", colour = "black") + 
  geom_point(size = 3, aes(colour = lineage)) + 
  scale_colour_manual(values = lineage_cols) + 
  labs(x = "Length (mm)", 
       y = "CTmax (degrees C)") + 
  theme_matt(base_size = 16) + 
  theme(legend.position = "bottom")
```



